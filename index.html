<!doctype html>
<html>
  <head>
    <title>IsoCanvas</title>
    <meta charset="utf-8" />
    <style>
      * {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      
      #c {
        background: hsl(80, 80%, 10%) ;
      }
      
      #resources {
        float: left;
        display: none;
        visibility: hidden;
      }
    </style>
   <!-- <script src="easel.js"></script> -->
  </head>
  <body>
    <canvas id="c" width="500" height="500"></canvas>
  </body>
  <!-- EaselJS -->
  <script src="lib/easeljs/utils/UID.js"></script>
  <script src="lib/easeljs/geom/Matrix2D.js"></script>
  <script src="lib/easeljs/geom/Rectangle.js"></script>
  <script src="lib/easeljs/events/MouseEvent.js"></script>
  <script src="lib/easeljs/utils/SpriteSheetUtils.js"></script>
  <script src="lib/easeljs/display/SpriteSheet.js"></script>
  <script src="lib/easeljs/display/DisplayObject.js"></script>
  <script src="lib/easeljs/display/Container.js"></script>
  <script src="lib/easeljs/display/Stage.js"></script>
  <script src="lib/easeljs/display/BitmapAnimation.js"></script>
  <script src="lib/easeljs/display/Bitmap.js"></script>
  <script src="lib/easeljs/display/Text.js"></script>
  <script src="lib/easeljs/display/Graphics.js"></script>
  <script src="lib/easeljs/display/Shape.js"></script>
  <script src="lib/easeljs/utils/Ticker.js"></script>

  <!-- topdown -->
  <script src="constants.js"></script>
  <script src="vector.js"></script>
  <script src="utils.js"></script>
  <script src="world.js"></script>
  <script src="keyboard.js"></script>

  <!-- game objects -->
  <script src="models.js"></script>
  <script src="views.js"></script>

<script>
  var canvas = document.getElementById('c')
  canvas.width = screenSize.x
  canvas.height = screenSize.y

  var stage = new Stage(canvas)
  
  var lastTick = Date.now()

  function init(stage, level) {
    stage.removeAllChildren()
    stage.addChild(stage.ground = new Container())
    stage.addChild(stage.actors = new Container())
    stage.addChild(stage.info = new Container())
    var world = new World()
    var view = new View(world)
    world.onadd   = view.init.bind(view)
    world.onrm    = view.rm.bind(view)
    world.ontick  = view.tick.bind(view)
    var models = model(world) // get tank, missile, and rocks
    var views = viewers(view, stage)
    level(world, models, stage)
          
      Ticker.setFPS( TARGET_FPS );
      Ticker.addListener({
        tick: function () { world.tick() }
      });

  }

  //this is how to load the next level!
  //window.onclick = function () {init(stage, deathmatch)}
  //need to use dependency injection, 

  var score = {
    green: 0,
    brown: 0
  }

  var ctrl;    
  var opts = argv(window.location.search)
  if(opts.dvorak) {
    ctrl = {
      green: {
        '80'  : 'forward' , '85'  : 'reverse' ,
        '69'  : 'left'    , '73'  : 'right'   ,
        '186' : 'rLeft'   , '188' : 'rRight' ,
        '190' : 'fire'
      },
      brown: {
        '38'  : 'forward' , '40'  : 'reverse' ,
        '37'  : 'left'    , '39'  : 'right'   ,
        '87'  : 'rLeft'   , '86'  : 'rRight'  ,
        '90'  : 'fire'
      }
    }
  } else {
    ctrl = {
      green: {
        '82': 'forward',  '70': 'reverse',
        '68': 'left',     '71': 'right',
        '69': 'rLeft',    '81': 'rRight',
        '87': 'fire'
      },
      brown: {
        '38': 'forward',  '40': 'reverse', 
        '37': 'left',     '39': 'right', 
        '191': 'rLeft',   '188': 'rRight',
        '190': 'fire'
      }
    }
  }
  var pairs = {
    'left,right'      : 'turn',
    'forward,reverse' : 'accelerate',
    'rLeft,rRight'    : 'rotate'
  }

  //setTimeout(init, 1000)
  
  init(stage, deathmatch)

  function deathmatch(world, models, stage) {
  
    var spacer = v(100, 100)
    var spawn = {
      green: spacer,
      brown: screenSize.sub(spacer)
    }

    var listeners = window.onkeyup = window.onkeydown = createListener([])

    window.players = {}
    function createPlayer(name) {
      var player = models.createTank(name, spawn[name].clone())
      var listener = createKBHandler (ctrl[name], pairs, player)
      listeners.listeners.push(listener)      

      player.ondeath = function () {
        score[name == 'green' ? 'brown': 'green'] ++
        updateScore()
        listeners.remove(listener)
        setTimeout(function () {
          createPlayer(name)
        }, 2000)
      }
      window.players[name] = player
      world.add(player)
      return player
    }
    
    createPlayer('green')
    createPlayer('brown')
    
    // it might be better to do this with an html layer over the top of the canvas.
    function updateScore() {
      messages.removeAllChildren()
      var t1 = new Text('Player1 : ' + score.green, '24px courier', Graphics.getRGB( 0, 255, 0 ))
      var t2 = new Text('Player2 : ' + score.brown, '24px courier', Graphics.getRGB( 0, 255, 0 ))
      t1.x = 50
      t1.y = 50
      t2.x = screenSize.x - 200
      t2.y = screenSize.y - 50
      messages.addChild(t1)
      messages.addChild(t2)
    }
    var messages = new Container() 
    updateScore()
    stage.info.addChild(messages)

    var l = ROCKS
    while (l--) { world.add(models.createRock()) }

    function image(id) {
      return document.getElementById(id)
    }
    
    stage.update()
  }

  </script>
</html>
